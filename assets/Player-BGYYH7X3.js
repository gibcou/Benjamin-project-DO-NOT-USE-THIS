import{u as X,j as e,d as J,a as K,s as W}from"./index-B_udihvL.js";import{u as Y,c as Z,r as o,L as ee}from"./router-C9DcrvDc.js";import{a as u}from"./axios-B9ygI19o.js";import{c as se,d as te,e as ae}from"./index-D7xXc7HB.js";import{S as re,F as w,f as oe,e as ie,g as ne}from"./Sidebar-B4R_yOif.js";import{G as M}from"./icons-N4PBxQYU.js";import{a as ce}from"./BookSkeleton-BmbjG9pU.js";import"./vendor-CRB3T2We.js";import"./logo-wOVLm2xr.js";function le(n){return M({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M18 13c0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6v4l5-5-5-5v4c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8h-2z"},child:[]},{tag:"path",attr:{d:"M10.86 15.94v-4.27h-.09L9 12.3v.69l1.01-.31v3.26zM12.25 13.44v.74c0 1.9 1.31 1.82 1.44 1.82.14 0 1.44.09 1.44-1.82v-.74c0-1.9-1.31-1.82-1.44-1.82-.14 0-1.44-.09-1.44 1.82zm2.04-.12v.97c0 .77-.21 1.03-.59 1.03s-.6-.26-.6-1.03v-.97c0-.75.22-1.01.59-1.01.38-.01.6.26.6 1.01z"},child:[]}]})(n)}function de(n){return M({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M11.99 5V1l-5 5 5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6h-2c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"},child:[]},{tag:"path",attr:{d:"M10.89 16h-.85v-3.26l-1.01.31v-.69l1.77-.63h.09V16zM15.17 14.24c0 .32-.03.6-.1.82s-.17.42-.29.57-.28.26-.45.33-.37.1-.59.1-.41-.03-.59-.1-.33-.18-.46-.33-.23-.34-.3-.57-.11-.5-.11-.82v-.74c0-.32.03-.6.1-.82s.17-.42.29-.57.28-.26.45-.33.37-.1.59-.1.41.03.59.1.33.18.46.33.23.34.3.57.11.5.11.82v.74zm-.85-.86c0-.19-.01-.35-.04-.48s-.07-.23-.12-.31-.11-.14-.19-.17-.16-.05-.25-.05-.18.02-.25.05-.14.09-.19.17-.09.18-.12.31-.04.29-.04.48v.97c0 .19.01.35.04.48s.07.24.12.32.11.14.19.17.16.05.25.05.18-.02.25-.05.14-.09.19-.17.09-.19.11-.32.04-.29.04-.48v-.97z"},child:[]}]})(n)}function ve(){const{id:n}=Y(),j=Z(),{user:l}=X(s=>s.user),m=l==null?void 0:l.uid,_=(l==null?void 0:l.isSubscribed)||!1,[i,E]=o.useState(null),[T,v]=o.useState(!0),[h,f]=o.useState(!1),[N,L]=o.useState(0),[k,P]=o.useState(0),t=o.useRef(null),[d,S]=o.useState(""),[p,x]=o.useState([]),[g,R]=o.useState([]),[A,C]=o.useState({}),[y,z]=o.useState(!1),b=()=>{z(!y)};o.useEffect(()=>{(async()=>{try{v(!0);const a=await u.get(`https://us-central1-summaristt.cloudfunctions.net/getBook?id=${n}`);a.data&&E(a.data)}catch(a){console.error("Error fetching book:",a)}finally{v(!1)}})()},[n]),o.useEffect(()=>{i&&i.subscriptionRequired&&!_&&j("/choose-plan")},[i,_,j]),o.useEffect(()=>{(async()=>{try{const[a,r,c]=await Promise.all([u.get("https://us-central1-summaristt.cloudfunctions.net/getBooks?status=selected"),u.get("https://us-central1-summaristt.cloudfunctions.net/getBooks?status=recommended"),u.get("https://us-central1-summaristt.cloudfunctions.net/getBooks?status=suggested")]),V=[...a.data||[],...r.data||[],...c.data||[]].filter((q,G,H)=>G===H.findIndex(Q=>Q.id===q.id));R(V)}catch(a){console.error("Error fetching books:",a)}})()},[]),o.useEffect(()=>{if(d.trim()===""){x([]);return}const s=async()=>{try{const r=await u.get(`https://us-central1-summaristt.cloudfunctions.net/getBooksByAuthorOrTitle?search=${encodeURIComponent(d)}`);r.data&&x(r.data)}catch(r){console.error("Error fetching search results:",r),x([])}},a=setTimeout(()=>{s()},300);return()=>clearTimeout(a)},[d]),o.useEffect(()=>{const s=async()=>{const a={};await Promise.all(g.map(async r=>{if(r.audioLink)try{const c=await ne(r.audioLink);a[r.id]=c}catch(c){console.error(`Error loading duration for ${r.id}:`,c),a[r.id]=null}})),C(a)};g.length>0&&s()},[g]),o.useEffect(()=>{const s=async()=>{if(!(!m||!i))try{const a=J(K,"users",m,"finished",n);await W(a,{...i,finishedAt:new Date().toISOString()})}catch(a){console.error("Error saving finished book:",a)}};return t.current&&t.current.addEventListener("ended",s),()=>{t.current&&t.current.removeEventListener("ended",s)}},[m,n,i]);const D=()=>{t.current&&(h?t.current.pause():t.current.play(),f(!h))},O=()=>{t.current&&(t.current.currentTime=Math.max(0,t.current.currentTime-10))},$=()=>{t.current&&(t.current.currentTime=Math.min(t.current.duration,t.current.currentTime+10))},F=()=>{t.current&&L(t.current.currentTime)},I=()=>{t.current&&P(t.current.duration)},U=s=>{if(t.current){const r=s.currentTarget.getBoundingClientRect(),c=(s.clientX-r.left)/r.width;t.current.currentTime=c*t.current.duration}},B=s=>{if(isNaN(s))return"0:00";const a=Math.floor(s/60),r=Math.floor(s%60);return`${a}:${r.toString().padStart(2,"0")}`};return e.jsxs("div",{className:"player-page",children:[e.jsx(re,{isSidebarOpen:y,toggleSidebar:b}),e.jsxs("main",{className:"player-content",children:[e.jsxs("div",{className:"fixed-header",children:[e.jsxs("div",{className:"mobile-header-wrapper",children:[e.jsx("button",{className:"hamburger-menu",onClick:b,children:y?e.jsx(se,{}):e.jsx(te,{})}),e.jsx("div",{className:"search-bar-container",children:e.jsxs("div",{className:"search-bar",children:[e.jsx("input",{type:"text",className:"search-bar__input",placeholder:"Search for books",value:d,onChange:s=>S(s.target.value)}),e.jsx("div",{className:"search-bar__divider"}),e.jsx(ae,{className:"search-bar__icon"})]})})]}),d.trim()!==""&&p.length===0&&e.jsx("div",{className:"search-results",children:e.jsx("div",{className:"search-no-results",children:"No books found"})}),p.length>0&&e.jsx("div",{className:"search-results",children:p.map(s=>e.jsxs(ee,{to:`/book/${s.id}`,className:"search-result",onClick:()=>S(""),children:[e.jsx("img",{src:s.imageLink,alt:s.title,className:"search-result__image"}),e.jsxs("div",{className:"search-result__info",children:[e.jsx("h4",{className:"search-result__title",children:s.title}),e.jsx("p",{className:"search-result__author",children:s.author}),e.jsxs("div",{className:"search-result__duration",children:[e.jsx(w,{className:"search-result__play-icon"}),e.jsx("span",{children:s.audioLink?oe(A[s.id]):"N/A"})]})]})]},s.id))})]}),T?e.jsx(ce,{}):i?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"player-header",children:e.jsx("h1",{className:"player-header__title",children:i.title})}),e.jsx("div",{className:"player-summary",children:e.jsx("p",{className:"player-summary__text",children:i.summary})})]}):e.jsx("div",{className:"player-error",children:"Book not found"})]}),i&&i.audioLink&&e.jsxs("div",{className:"player-audio-footer",children:[e.jsx("audio",{ref:t,src:i.audioLink,preload:"metadata",onPlay:()=>f(!0),onPause:()=>f(!1),onTimeUpdate:F,onLoadedMetadata:I}),e.jsxs("div",{className:"player-audio-footer__left",children:[e.jsx("img",{src:i.imageLink,alt:i.title,className:"player-audio-footer__image"}),e.jsxs("div",{className:"player-audio-footer__info",children:[e.jsx("h3",{className:"player-audio-footer__title",children:i.title}),e.jsx("p",{className:"player-audio-footer__author",children:i.author})]})]}),e.jsxs("div",{className:"player-audio-footer__controls",children:[e.jsx("button",{className:"player-audio-footer__btn",onClick:O,"aria-label":"Skip backward 10 seconds",children:e.jsx(de,{})}),e.jsx("button",{className:"player-audio-footer__btn player-audio-footer__btn--play",onClick:D,"aria-label":h?"Pause":"Play",children:h?e.jsx(ie,{}):e.jsx(w,{})}),e.jsx("button",{className:"player-audio-footer__btn",onClick:$,"aria-label":"Skip forward 10 seconds",children:e.jsx(le,{})})]}),e.jsxs("div",{className:"player-audio-footer__right",children:[e.jsx("span",{className:"player-audio-footer__time",children:B(N)}),e.jsx("div",{className:"player-audio-footer__progress",onClick:U,children:e.jsx("div",{className:"player-audio-footer__progress-bar",style:{width:`${N/k*100}%`}})}),e.jsx("span",{className:"player-audio-footer__time",children:B(k)})]})]})]})}export{ve as default};
