import{u as Q,j as e,d as S,a as y,g as K,b as U,s as W}from"./index-DHrie53P.js";import{u as z,r as o,L as f}from"./router-C9DcrvDc.js";import{a as h}from"./axios-B9ygI19o.js";import{c as G,d as H,e as J,f as V,g as X}from"./index-D7xXc7HB.js";import{b as Y,c as Z}from"./logo-C4jNZC9r.js";import{S as ee,F as se,f as A,d as ae,g as B}from"./Sidebar-Caz2RvkM.js";import{a as te}from"./index-B-2HsB6D.js";import{a as oe}from"./BookSkeleton-CaxjV84s.js";import"./vendor-CRB3T2We.js";import"./icons-N4PBxQYU.js";function fe(){const{id:r}=z(),{isAuthenticated:D,user:l}=Q(t=>t.user),d=l==null?void 0:l.uid,j=(l==null?void 0:l.isSubscribed)||!1,[a,E]=o.useState(null),[R,g]=o.useState(!0),[m,n]=o.useState(null),[L,N]=o.useState(null),[ie,re]=o.useState(!0),[u,p]=o.useState(""),[k,_]=o.useState([]),[b,w]=o.useState([]),[I,O]=o.useState({}),[x,T]=o.useState(!1),v=()=>{T(!x)};o.useEffect(()=>{(async()=>{try{g(!0);const s=await h.get(`https://us-central1-summaristt.cloudfunctions.net/getBook?id=${r}`);s.data&&E(s.data)}catch(s){console.error("Error fetching book:",s)}finally{g(!1)}})()},[r]),o.useEffect(()=>{(async()=>{if(!d||!r){n(!1);return}try{const s=S(y,"users",d,"library",r),c=(await K(s)).exists();n(c)}catch(s){console.error("Error checking if book is saved:",s),n(!1)}})()},[d,r]),o.useEffect(()=>{(async()=>{if(a!=null&&a.audioLink)try{const s=await B(a.audioLink);N(s)}catch(s){console.error("Error loading audio duration:",s),N(null)}})()},[a]),o.useEffect(()=>{(async()=>{try{const[s,i,c]=await Promise.all([h.get("https://us-central1-summaristt.cloudfunctions.net/getBooks?status=selected"),h.get("https://us-central1-summaristt.cloudfunctions.net/getBooks?status=recommended"),h.get("https://us-central1-summaristt.cloudfunctions.net/getBooks?status=suggested")]),$=[...s.data||[],...i.data||[],...c.data||[]].filter((F,M,P)=>M===P.findIndex(q=>q.id===F.id));w($)}catch(s){console.error("Error fetching books:",s)}})()},[]),o.useEffect(()=>{if(u.trim()===""){_([]);return}const t=async()=>{try{const i=await h.get(`https://us-central1-summaristt.cloudfunctions.net/getBooksByAuthorOrTitle?search=${encodeURIComponent(u)}`);i.data&&_(i.data)}catch(i){console.error("Error fetching search results:",i),_([])}},s=setTimeout(()=>{t()},300);return()=>clearTimeout(s)},[u]),o.useEffect(()=>{const t=async()=>{const s={};await Promise.all(b.map(async i=>{if(i.audioLink)try{const c=await B(i.audioLink);s[i.id]=c}catch(c){console.error(`Error loading duration for ${i.id}:`,c),s[i.id]=null}})),O(s)};b.length>0&&t()},[b]);const C=async()=>{if(!D||!d||!a)return;const t=m;n(!t);try{const s=S(y,"users",d,"library",r);t?await U(s):await W(s,{...a,savedAt:new Date().toISOString()})}catch(s){console.error("Error toggling save:",s),n(t)}};return e.jsxs("div",{className:"book-detail-page",children:[e.jsx(ee,{isSidebarOpen:x,toggleSidebar:v}),e.jsxs("main",{className:"book-detail-content",children:[e.jsxs("div",{className:"fixed-header",children:[e.jsxs("div",{className:"mobile-header-wrapper",children:[e.jsx("button",{className:"hamburger-menu",onClick:v,children:x?e.jsx(G,{}):e.jsx(H,{})}),e.jsx("div",{className:"search-bar-container",children:e.jsxs("div",{className:"search-bar",children:[e.jsx("input",{type:"text",className:"search-bar__input",placeholder:"Search for books",value:u,onChange:t=>p(t.target.value)}),e.jsx("div",{className:"search-bar__divider"}),e.jsx(J,{className:"search-bar__icon"})]})})]}),u.trim()!==""&&k.length===0&&e.jsx("div",{className:"search-results",children:e.jsx("div",{className:"search-no-results",children:"No books found"})}),k.length>0&&e.jsx("div",{className:"search-results",children:k.map(t=>e.jsxs(f,{to:`/book/${t.id}`,className:"search-result",onClick:()=>p(""),children:[e.jsx("img",{src:t.imageLink,alt:t.title,className:"search-result__image"}),e.jsxs("div",{className:"search-result__info",children:[e.jsx("h4",{className:"search-result__title",children:t.title}),e.jsx("p",{className:"search-result__author",children:t.author}),e.jsxs("div",{className:"search-result__duration",children:[e.jsx(se,{className:"search-result__play-icon"}),e.jsx("span",{children:t.audioLink?A(I[t.id]):"N/A"})]})]})]},t.id))})]}),R?e.jsx(oe,{}):a?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"book-detail-header",children:[e.jsxs("div",{className:"book-detail-header__info",children:[e.jsx("h1",{className:"book-detail-header__title",children:a.title}),e.jsx("p",{className:"book-detail-header__author",children:a.author}),e.jsx("p",{className:"book-detail-header__subtitle",children:a.subTitle}),e.jsx("div",{className:"book-detail-header__divider"}),e.jsxs("div",{className:"book-detail-header__stats",children:[e.jsxs("div",{className:"book-detail-header__stats-left",children:[e.jsxs("div",{className:"book-detail-stat",children:[e.jsx(V,{className:"book-detail-stat__icon"}),e.jsxs("span",{className:"book-detail-stat__text",children:[a.averageRating||"N/A"," (",a.totalRating||0,")"]})]}),e.jsxs("div",{className:"book-detail-stat",children:[e.jsx(ae,{className:"book-detail-stat__icon"}),e.jsx("span",{className:"book-detail-stat__text",children:"Audio & Text"})]})]}),e.jsxs("div",{className:"book-detail-header__stats-right",children:[e.jsxs("div",{className:"book-detail-stat",children:[e.jsx(te,{className:"book-detail-stat__icon"}),e.jsx("span",{className:"book-detail-stat__text",children:a.audioLink?A(L):"N/A"})]}),e.jsxs("div",{className:"book-detail-stat",children:[e.jsx(X,{className:"book-detail-stat__icon"}),e.jsxs("span",{className:"book-detail-stat__text",children:[a.keyIdeas||0," Key Ideas"]})]})]})]}),e.jsx("div",{className:"book-detail-header__divider"}),e.jsxs("div",{className:"book-detail-header__buttons",children:[e.jsx(f,{to:a.subscriptionRequired&&!j?"/choose-plan":`/player/${r}`,className:"book-detail-header__btn book-detail-header__btn--primary",children:"Read"}),e.jsx(f,{to:a.subscriptionRequired&&!j?"/choose-plan":`/player/${r}`,className:"book-detail-header__btn book-detail-header__btn--secondary",children:"Listen"})]}),e.jsxs("div",{className:`book-detail-header__save ${m?"book-detail-header__save--active":""}`,onClick:C,children:[m?e.jsx(Y,{className:"book-detail-header__save-icon"}):e.jsx(Z,{className:"book-detail-header__save-icon"}),e.jsx("span",{className:"book-detail-header__save-text",children:m?"Saved in My Library":"Add title to My Library"})]}),a.tags&&a.tags.length>0&&e.jsxs("div",{className:"book-detail-tags",children:[e.jsx("h3",{className:"book-detail-tags__heading",children:"What's it about?"}),e.jsx("div",{className:"book-detail-tags__list",children:a.tags.map((t,s)=>e.jsx("div",{className:"book-detail-tag",children:t},s))})]}),a.bookDescription&&e.jsx("p",{className:"book-detail-description",children:a.bookDescription}),a.authorDescription&&e.jsxs("div",{className:"book-detail-author",children:[e.jsx("h3",{className:"book-detail-author__heading",children:"About the Author"}),e.jsx("p",{className:"book-detail-author__description",children:a.authorDescription})]})]}),e.jsx("div",{className:"book-detail-header__image-wrapper",children:e.jsx("img",{src:a.imageLink,alt:a.title,className:"book-detail-header__image"})})]})}):e.jsx("div",{className:"book-detail-error",children:"Book not found"})]})]})}export{fe as default};
